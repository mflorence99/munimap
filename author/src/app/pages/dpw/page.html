<ng-container *ngIf="(mapState$ | async) as map">
  <app-ol-map
    #olMap
    [loadingStrategy]="'bbox'"
    [minZoom]="13"
    [maxZoom]="20"
    [path]="map.path"
  >
    <app-controlpanel-properties
      [map]="map"
      mapControlPanel1
    ></app-controlpanel-properties>

    <app-ol-control-zoom mapControlZoom></app-ol-control-zoom>

    <app-ol-control-print
      *ngIf="map.name"
      [fileName]="map.name"
      [printSize]="map.printSize"
      mapControlPrint
    ></app-ol-control-print>

    <app-ol-control-zoom2extent
      mapControlZoomToExtent
    ></app-ol-control-zoom2extent>

    <app-ol-control-attribution
      mapControlAttribution
    ></app-ol-control-attribution>

    <ng-container *ngIf="olMap.initialized">
      <!-- ðŸ“¦ OL CONTROLS -- WILL BE PRINTED -->

      <app-ol-control-graticule *ngIf="olMap.printing"
        ><app-ol-style-graticule [printing]="true"></app-ol-style-graticule
      ></app-ol-control-graticule>

      <app-ol-control-graticule *ngIf="!olMap.printing"
        ><app-ol-style-graticule></app-ol-style-graticule
      ></app-ol-control-graticule>

      <app-ol-control-dpwlegend
        *ngIf="map.name && olMap.printing"
        [county]="map.path.split(':')[1]"
        [id]="map.id"
        [printing]="olMap.printing"
        [state]="map.path.split(':')[0]"
        [title]="map.name"
      ></app-ol-control-dpwlegend>

      <app-ol-control-scalebar *ngIf="olMap.printing"></app-ol-control-scalebar>

      <app-ol-control-scaleline
        *ngIf="!olMap.printing"
      ></app-ol-control-scaleline>

      <app-ol-control-credits *ngIf="olMap.printing"></app-ol-control-credits>

      <!-- ðŸ“¦ NORMAL (not satellite) LAYERS -->

      <ng-container *ngIf="!(satelliteView$ | async)">
        <!-- ðŸ“¦ BG LAYER (outside town)-->

        <app-ol-layer-tile *ngIf="olMap.printing">
          <app-ol-source-xyz
            [url]="'https://api.mapbox.com/styles/v1/mapbox/streets-v8/tiles/256/{z}/{x}/{y}?access_token=' + env.mapbox.apiKey"
            ><app-ol-attribution
              >Â©
              <a href="https://mapbox.com" target="_blank"
                >Mapbox</a
              ></app-ol-attribution
            ></app-ol-source-xyz
          >
          <app-ol-filter-colorize
            [color]="[255, 255, 255]"
            [operation]="'hue'"
            [value]="0.9"
          ></app-ol-filter-colorize>
        </app-ol-layer-tile>

        <!-- ðŸ“¦ HILLSHADE LAYER =-->

        <app-ol-layer-tile [opacity]="0.5">
          <app-ol-source-hillshade [colorize]="true"> </app-ol-source-hillshade>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-tile>

        <!-- ðŸ“¦ NH GranIT VECTOR LAYERS -->

        <app-ol-layer-vector>
          <app-ol-adaptor-wetlands>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-wetlands>
          <app-ol-source-wetlands></app-ol-source-wetlands>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <!-- ðŸ‘‡ only drawing labels here - waterbodies draws actual river -->
          <app-ol-adaptor-places>
            <app-ol-style-universal [showText]="true"></app-ol-style-universal>
          </app-ol-adaptor-places>
          <app-ol-source-rivers></app-ol-source-rivers>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-waterbodies>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-waterbodies>
          <!-- ðŸ‘‡ exclude swamp/marsh b/c floodplain source below does it better -->
          <app-ol-source-waterbodies
            [exclude]="[466]"
          ></app-ol-source-waterbodies>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-stonewalls>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-stonewalls>
          <app-ol-source-stonewalls></app-ol-source-stonewalls>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-floodplains>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-floodplains>
          <app-ol-source-floodplains></app-ol-source-floodplains>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-buildings>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-buildings>
          <app-ol-source-geojson
            [layerKey]="'buildings'"
          ></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-railroads>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-railroads>
          <app-ol-source-railroads></app-ol-source-railroads>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-roads
            ><app-ol-style-universal [showAll]="true"></app-ol-style-universal
          ></app-ol-adaptor-roads>
          <app-ol-source-geojson [layerKey]="'roads'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-trails>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-trails>
          <app-ol-source-geojson [layerKey]="'trails'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-places>
            <app-ol-style-universal [showText]="true"></app-ol-style-universal>
          </app-ol-adaptor-places>
          <!-- ðŸ‘‡ dams excluded from "places" b/c "dams" below does it better -->
          <app-ol-source-geojson
            [exclude]="['dam', 'park']"
            [layerKey]="'places'"
          ></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-places>
            <app-ol-style-universal [showText]="true"></app-ol-style-universal>
          </app-ol-adaptor-places>
          <app-ol-source-dams></app-ol-source-dams>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector #bridges>
          <app-ol-adaptor-bridges [bridgeWidth]="128">
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-bridges>
          <app-ol-source-bridges></app-ol-source-bridges>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector #streamcrossings>
          <app-ol-adaptor-streamcrossings [streamCrossingWidth]="128">
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-streamcrossings>
          <app-ol-source-streamcrossings></app-ol-source-streamcrossings>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector #floodhazards>
          <app-ol-adaptor-floodhazards [floodHazardWidth]="128">
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal>
          </app-ol-adaptor-floodhazards>
          <app-ol-source-floodhazards></app-ol-source-floodhazards>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-adaptor-powerlines
            ><app-ol-style-universal [showAll]="true"></app-ol-style-universal
          ></app-ol-adaptor-powerlines>
          <app-ol-source-geojson
            [layerKey]="'powerlines'"
          ></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <!-- ðŸ“¦ DPW'S LANDMARKS -->

        <app-ol-layer-vector #landmarks>
          <app-ol-adaptor-landmarks>
            <app-ol-style-universal [showAll]="true"></app-ol-style-universal
          ></app-ol-adaptor-landmarks>
          <app-ol-source-landmarks></app-ol-source-landmarks>
          <app-ol-interaction-selectlandmarks
            [layers]="[bridges, streamcrossings, floodhazards, landmarks]"
            [multi]="false"
          >
          </app-ol-interaction-selectlandmarks>
        </app-ol-layer-vector>
      </ng-container>

      <!-- ðŸ“¦ SATELLITE LAYER  -->

      <ng-container *ngIf="satelliteView$ | async">
        <app-ol-layer-tile>
          <app-ol-source-xyz
            [s]="['mt0', 'mt1', 'mt2', 'mt3']"
            [url]="'https://{s}.google.com/vt/lyrs=s,h&hl=en&gl=en&x={x}&y={y}&z={z}&s=png&key=' + env.google.apiKey"
            ><app-ol-attribution
              >Â©
              <a href="https://google.com" target="_blank"
                >Google</a
              ></app-ol-attribution
            ></app-ol-source-xyz
          >
        </app-ol-layer-tile>

        <app-ol-layer-vector #bridges>
          <app-ol-adaptor-bridges [bridgeWidth]="128">
            <app-ol-style-universal
              [contrast]="'whiteOnBlack'"
              [showAll]="true"
            ></app-ol-style-universal>
          </app-ol-adaptor-bridges>
          <app-ol-source-bridges></app-ol-source-bridges>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector #streamcrossings>
          <app-ol-adaptor-streamcrossings [streamCrossingWidth]="128">
            <app-ol-style-universal
              [contrast]="'whiteOnBlack'"
              [showAll]="true"
            ></app-ol-style-universal>
          </app-ol-adaptor-streamcrossings>
          <app-ol-source-streamcrossings></app-ol-source-streamcrossings>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector #floodhazards>
          <app-ol-adaptor-floodhazards [floodHazardWidth]="128">
            <app-ol-style-universal
              [contrast]="'whiteOnBlack'"
              [showAll]="true"
            ></app-ol-style-universal>
          </app-ol-adaptor-floodhazards>
          <app-ol-source-floodhazards></app-ol-source-floodhazards>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector #landmarks>
          <app-ol-adaptor-landmarks>
            <app-ol-style-universal
              [contrast]="'whiteOnBlack'"
              [showAll]="true"
            ></app-ol-style-universal
          ></app-ol-adaptor-landmarks>
          <app-ol-source-landmarks></app-ol-source-landmarks>
          <app-ol-interaction-selectlandmarks
            [layers]="[bridges, streamcrossings, floodhazards, landmarks]"
            [multi]="false"
          >
          </app-ol-interaction-selectlandmarks>
        </app-ol-layer-vector>
      </ng-container>

      <!-- ðŸ“¦ BOUNDARY LAYER -->

      <app-ol-layer-vector>
        <app-ol-adaptor-boundary
          ><app-ol-style-universal [showStroke]="true"></app-ol-style-universal
        ></app-ol-adaptor-boundary>
        <app-ol-source-boundary></app-ol-source-boundary>
      </app-ol-layer-vector>
    </ng-container>

    <!-- ðŸ“¦ CONTROLS -->
  </app-ol-map>
</ng-container>
