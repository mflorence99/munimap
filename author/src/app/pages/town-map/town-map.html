<mat-drawer-container *ngIf="(mapState$ | async) as map" class="container">
  <mat-drawer-content class="content">
    <app-ol-map #olMap [minZoom]="13" [maxZoom]="22" [path]="map.path">
      <app-town-map-setup
        [map]="map"
        class="setup"
        mapControlPanel1
      ></app-town-map-setup>

      <!-- ðŸ“¦ CONTROLS -->

      <app-ol-control-searchparcels
        mapControlSearch
      ></app-ol-control-searchparcels>

      <app-ol-control-zoom mapControlZoom></app-ol-control-zoom>

      <app-ol-control-print
        *ngIf="map.name"
        [fileName]="map.name"
        mapControlPrint
      ></app-ol-control-print>

      <app-ol-control-zoom2extent
        mapControlZoomToExtent
      ></app-ol-control-zoom2extent>

      <app-ol-control-attribution
        mapControlAttribution
      ></app-ol-control-attribution>

      <ng-container *ngIf="olMap.initialized">
        <!-- ðŸ“¦ OL CONTROLS -- WILL BE PRINTED -->

        <app-ol-control-graticule
          ><app-ol-style-graticule></app-ol-style-graticule
        ></app-ol-control-graticule>

        <app-ol-control-legend
          *ngIf="map.name && olMap.printing"
          [county]="map.path.split(':')[1]"
          [printing]="olMap.printing"
          [state]="map.path.split(':')[0]"
          [title]="map.name"
        ></app-ol-control-legend>

        <!-- ðŸ”¥ DPI isn't right -->

        <app-ol-control-scaleline
          *ngIf="olMap.printing"
          [printing]="olMap.printing"
        ></app-ol-control-scaleline>

        <app-ol-control-scaleline
          *ngIf="!olMap.printing"
        ></app-ol-control-scaleline>

        <app-ol-control-credits *ngIf="olMap.printing"></app-ol-control-credits>

        <!-- ðŸ“¦ BG LAYER (outside town)-->

        <app-ol-layer-tile>
          <app-ol-source-osm></app-ol-source-osm>
          <app-ol-filter-pencil></app-ol-filter-pencil>
        </app-ol-layer-tile>

        <!-- ðŸ“¦ BG LAYER (lays down a texture inside town)-->

        <app-ol-layer-vector>
          <app-ol-style-boundary></app-ol-style-boundary>
          <app-ol-source-boundary></app-ol-source-boundary>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <!-- ðŸ“¦ HILLSHADE LAYER =-->

        <app-ol-layer-tile [opacity]="1">
          <app-ol-source-xyz
            [maxZoom]="17"
            [url]="'https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}'"
          >
            <app-ol-attribution
              >Powered by
              <a href="https://www.esri.com" target="_blank"
                >Esri</a
              ></app-ol-attribution
            >
          </app-ol-source-xyz>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-tile>

        <!-- ðŸ“¦ NH GranIT VECTOR LAYERS -->

        <app-ol-layer-vector>
          <app-ol-style-lakes></app-ol-style-lakes>
          <app-ol-source-geojson [layerKey]="'lakes'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-parcels
            [showBackground]="true"
            [showBorder]="true"
          ></app-ol-style-parcels>
          <app-ol-source-parcels></app-ol-source-parcels>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-rivers></app-ol-style-rivers>
          <app-ol-source-geojson [layerKey]="'rivers'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-roads></app-ol-style-roads>
          <app-ol-source-geojson [layerKey]="'roads'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-trails></app-ol-style-trails>
          <app-ol-source-geojson [layerKey]="'trails'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector *ngIf="!olMap.printing">
          <app-ol-style-stonewalls></app-ol-style-stonewalls>
          <app-ol-source-stonewalls></app-ol-source-stonewalls>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-buildings></app-ol-style-buildings>
          <app-ol-source-geojson
            [layerKey]="'buildings'"
          ></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-floods></app-ol-style-floods>
          <app-ol-source-geojson [layerKey]="'floods'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-powerlines></app-ol-style-powerlines>
          <app-ol-source-geojson
            [layerKey]="'powerlines'"
          ></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-parcels [showLabels]="true"></app-ol-style-parcels>
          <app-ol-source-parcels> </app-ol-source-parcels>
        </app-ol-layer-vector>

        <app-ol-layer-vector>
          <app-ol-style-places></app-ol-style-places>
          <app-ol-source-geojson [layerKey]="'places'"></app-ol-source-geojson>
          <app-ol-filter-crop2boundary></app-ol-filter-crop2boundary>
        </app-ol-layer-vector>

        <!-- ðŸ“¦ SATELLITE LAYER (not printed) -->

        <app-ol-layer-tile *ngIf="!olMap.printing">
          <app-ol-source-xyz
            [url]="'http://mt0.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'"
            ><app-ol-attribution
              >Â©
              <a href="https://www.google.com" target="_blank"
                >Google</a
              ></app-ol-attribution
            ></app-ol-source-xyz
          >
          <app-ol-filter-crop2selected></app-ol-filter-crop2selected>
        </app-ol-layer-tile>

        <!-- ðŸ“¦ SELECTION LAYER (not printed) -->

        <app-ol-layer-vector *ngIf="!olMap.printing">
          <app-ol-style-parcels
            [showDimensions]="true"
            [showLabelContrast]="true"
            [showLabels]="true"
            [showSelection]="true"
          ></app-ol-style-parcels>
          <app-ol-source-parcels></app-ol-source-parcels>
          <app-ol-interaction-redraw></app-ol-interaction-redraw>
          <app-ol-interaction-select [eventType]="'singleclick'" [multi]="true">
            <mat-menu #theContextMenu mapContextMenu>
              <ng-template matMenuContent>
                <ng-template [ngTemplateOutlet]="contextmenu"></ng-template>
              </ng-template>
            </mat-menu>
          </app-ol-interaction-select>
        </app-ol-layer-vector>

        <!-- ðŸ“¦ OVERLAY FOR LABEL REPOSITIONING -->

        <app-ol-overlay-label *ngIf="!olMap.printing"></app-ol-overlay-label>

        <!-- ðŸ“¦ BOUNDARY LAYER -->

        <app-ol-layer-vector>
          <app-ol-style-polygons></app-ol-style-polygons>
          <app-ol-source-boundary></app-ol-source-boundary>
        </app-ol-layer-vector>
      </ng-container>
    </app-ol-map>
  </mat-drawer-content>

  <!-- ðŸ“¦ DYNAMIC SIDEBAR-->

  <mat-drawer #drawer class="sidebar" mode="over" position="end">
    <ng-container appContextMenuHost></ng-container>
  </mat-drawer>
</mat-drawer-container>

<!-- ðŸ“¦ CONTEXT MENU -->

<ng-template #contextmenu>
  <nav class="contextmenu">
    <header class="header">
      Lorem ipsum {{ olMap.selector.selectedIDs.join(', ') }}
    </header>

    <ul>
      <li
        (click)="canParcelProperties($event) && onContextMenu('parcel-properties')"
        [class.disabled]="!canParcelProperties()"
        class="item"
      >
        <fa-icon [fixedWidth]="true" [icon]="['fas', 'tasks']"></fa-icon>
        Parcel details ...
      </li>

      <li
        (click)="canSubdivideParcel($event) && onContextMenu('subdivide-parcel')"
        [class.disabled]="!canSubdivideParcel()"
        class="item"
      >
        <fa-icon
          [fixedWidth]="true"
          [icon]="['fas', 'object-ungroup']"
        ></fa-icon>
        Subdivide parcel ...
      </li>

      <li
        (click)="canRedrawBoundary($event) && onContextMenu('redraw-boundary')"
        [class.disabled]="!canRedrawBoundary()"
        class="item"
      >
        <fa-icon [fixedWidth]="true" [icon]="['fas', 'draw-polygon']"></fa-icon>
        Redraw parcel boundary
      </li>

      <li
        (click)="canMergeParcels($event) && onContextMenu('merge-parcels')"
        [class.disabled]="!canMergeParcels()"
        class="item"
      >
        <fa-icon [fixedWidth]="true" [icon]="['fas', 'object-group']"></fa-icon>
        Merge parcels ...
      </li>

      <li
        (click)="canRecenterLabel($event) && onContextMenu('recenter-label')"
        [class.disabled]="!canRecenterLabel()"
        class="item"
      >
        <fa-icon [fixedWidth]="true" [icon]="['fas', 'crosshairs']"></fa-icon>
        Recenter label in parcel
      </li>
    </ul>
  </nav>
</ng-template>
